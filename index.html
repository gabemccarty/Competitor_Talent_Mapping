<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Talent Map – Globe-Based Competitor Talent Mapping</title>
  <style>
    :root {
      --bg-dark: #0d1117;
      --bg-medium: #161b22;
      --bg-light: #21262d;
      --bg-card: #1c2128;
      --text-primary: #f0f6fc;
      --text-secondary: #8b949e;
      --border-color: #30363d;
      --accent: #58a6ff;
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; height: 100%; overflow: hidden; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg-dark); color: var(--text-primary); }
    #landing {
      position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; padding: 24px; z-index: 5;
    }
    #landing.hidden { display: none; }
    .landing-card {
      width: 100%; max-width: 480px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 24px;
    }
    .landing-card h1 { margin: 0 0 8px 0; font-size: 1.35rem; }
    .landing-card p { color: var(--text-secondary); font-size: 0.9rem; margin: 0 0 16px 0; }
    .landing-card label { display: block; font-size: 0.85rem; margin-bottom: 4px; color: var(--text-secondary); }
    .landing-card input[type="text"] {
      width: 100%; padding: 10px 12px; margin-bottom: 16px; background: var(--bg-light); border: 1px solid var(--border-color);
      border-radius: 6px; color: var(--text-primary); font-size: 0.9rem;
    }
    .landing-card textarea {
      width: 100%; height: 160px; padding: 12px; margin-bottom: 12px; background: var(--bg-light); border: 1px solid var(--border-color);
      border-radius: 6px; color: var(--text-primary); font-size: 0.8rem; font-family: inherit; resize: vertical;
    }
    .landing-card .drop-zone {
      position: relative;
      border: 2px dashed var(--border-color); border-radius: 8px; padding: 24px; text-align: center; margin-bottom: 16px;
      color: var(--text-secondary); font-size: 0.9rem; cursor: pointer; transition: border-color 0.2s;
    }
    .landing-card .drop-zone:hover, .landing-card .drop-zone.dragover { border-color: var(--accent); color: var(--text-primary); }
    .landing-card .drop-zone input[type="file"] {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      opacity: 0;
      cursor: pointer;
      font-size: 0;
    }
    .landing-card button {
      width: 100%; padding: 12px; background: var(--accent); color: #fff; border: none; border-radius: 6px; font-size: 1rem; font-weight: 500; cursor: pointer;
    }
    .landing-card button:hover { filter: brightness(1.1); }
    .landing-card button:disabled { opacity: 0.6; cursor: not-allowed; }
    .landing-card .error { color: #f85149; font-size: 0.85rem; margin-top: 8px; }
    .landing-card .file-attached { color: var(--accent); font-size: 0.85rem; margin-top: 6px; }
    #map-view { position: absolute; inset: 0; display: none; flex-direction: column; z-index: 1; }
    #map-view.visible { display: flex; }
    #globe-container { flex: 1; position: relative; min-height: 0; }
    #globe-container canvas { display: block; width: 100%; height: 100%; cursor: grab; }
    #globe-container:active { cursor: grabbing; }
    #ui-overlay {
      position: absolute; top: 0; left: 0; right: 0; padding: 1rem 1.5rem;
      background: linear-gradient(to bottom, rgba(13,17,23,0.95) 0%, transparent 100%); pointer-events: none; z-index: 10;
    }
    #ui-overlay .inner { pointer-events: auto; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.75rem; }
    #ui-overlay h1 { margin: 0; font-size: 1.2rem; font-weight: 600; }
    #ui-overlay .subtitle { font-size: 0.8rem; color: var(--text-secondary); }
    #ui-overlay .stats { display: flex; gap: 1rem; font-size: 0.8rem; color: var(--text-secondary); }
    #ui-overlay .stats strong { color: var(--text-primary); }
    #panel {
      position: absolute; top: 0; right: 0; width: min(400px, 100vw); max-width: 100%; height: 100%;
      background: var(--bg-medium); border-left: 1px solid var(--border-color); box-shadow: -8px 0 24px rgba(0,0,0,0.4);
      transform: translateX(100%); transition: transform 0.3s ease; z-index: 20; display: flex; flex-direction: column; overflow: hidden;
    }
    #panel.open { transform: translateX(0); }
    #panel-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border-color); background: var(--bg-card); flex-shrink: 0; }
    #panel-header h2 { margin: 0 0 0.25rem 0; font-size: 1.05rem; }
    #panel-header .meta { font-size: 0.8rem; color: var(--text-secondary); }
    #panel-close {
      position: absolute; top: 1rem; right: 1rem; width: 32px; height: 32px; border: none; background: var(--bg-light);
      color: var(--text-primary); border-radius: 6px; cursor: pointer; font-size: 1.2rem; line-height: 1; padding: 0;
    }
    #panel-close:hover { background: var(--border-color); }
    #panel-content { flex: 1; overflow-y: auto; padding: 1rem; }
    .dept-card {
      background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 0.75rem; overflow: hidden;
    }
    .dept-card .dept-header {
      padding: 0.65rem 0.85rem; cursor: pointer; display: flex; align-items: center; justify-content: space-between;
      border-left: 4px solid var(--dept-color, var(--border-color)); transition: background 0.2s;
    }
    .dept-card .dept-header:hover { background: var(--bg-light); }
    .dept-card .dept-name { font-weight: 600; font-size: 0.9rem; }
    .dept-card .dept-count { font-size: 0.8rem; color: var(--text-secondary); }
    .dept-card .dept-body { padding: 0 0.85rem 0.85rem; }
    .dept-card.collapsed .dept-body { display: none; }
    .tier-section { margin-top: 0.65rem; }
    .tier-section .tier-title {
      font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary);
      margin-bottom: 0.35rem; padding-left: 0.25rem; border-left: 2px solid var(--dept-color, var(--border-color));
    }
    .employee-card {
      padding: 0.5rem 0.6rem; margin-bottom: 0.25rem; background: var(--bg-light); border-radius: 6px;
      border-left: 3px solid var(--dept-color, var(--border-color)); transition: transform 0.2s;
    }
    .employee-card:hover { transform: translateX(4px); }
    .employee-card .emp-name { font-weight: 500; font-size: 0.9rem; }
    .employee-card .emp-name a { color: var(--accent); text-decoration: none; }
    .employee-card .emp-name a:hover { text-decoration: underline; }
    .employee-card .emp-title { font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.15rem; }
    .employee-card .emp-location { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.1rem; }
    .hint {
      position: absolute; bottom: 1rem; left: 50%; transform: translateX(-50%); font-size: 0.75rem; color: var(--text-secondary);
      background: rgba(22,27,34,0.9); padding: 0.5rem 1rem; border-radius: 8px; pointer-events: none; z-index: 10;
    }
  </style>
</head>
<body>
  <div id="landing">
    <div class="landing-card">
      <h1>Talent Map</h1>
      <p>Paste a Gem CSV or drop a file below. Optionally filter by company name.</p>
      <label for="company-filter">Company filter (optional)</label>
      <input type="text" id="company-filter" placeholder="e.g. Meta">
      <label class="drop-zone" id="drop-zone" for="file-input">
        Drop CSV here or click to choose
        <input type="file" id="file-input" accept=".csv,text/csv,text/plain" aria-label="Choose CSV file">
      </label>
      <div id="file-attached" class="file-attached" aria-live="polite"></div>
      <label for="csv-paste">Or paste CSV</label>
      <textarea id="csv-paste" placeholder="Paste CSV content here (header row + data)"></textarea>
      <button type="button" id="generate-btn">Generate Map</button>
      <div class="error" id="landing-error"></div>
    </div>
  </div>
  <div id="map-view">
    <div id="globe-container"></div>
    <div id="ui-overlay">
      <div class="inner">
        <div>
          <h1 id="map-title">Talent Map</h1>
          <div class="subtitle">Click a pin to view org structure</div>
        </div>
        <div class="stats">
          <span class="stat"><strong id="total-count">0</strong> employees</span>
          <span class="stat"><strong id="location-count">0</strong> locations</span>
        </div>
      </div>
    </div>
    <div id="panel">
      <div id="panel-header">
        <button id="panel-close" type="button" aria-label="Close">&times;</button>
        <h2 id="panel-title">Location</h2>
        <div class="meta" id="panel-meta"></div>
      </div>
      <div id="panel-content"></div>
    </div>
    <div class="hint">Drag to rotate (horizontal + vertical) · Scroll to zoom · Click pins for org chart</div>
  </div>

  <script src="js/parser.js"></script>
  <script src="js/globe2d.js"></script>
  <script>
    (function () {
      var dropZone = document.getElementById('drop-zone');
      var fileInput = document.getElementById('file-input');
      var fileAttached = document.getElementById('file-attached');
      var csvPaste = document.getElementById('csv-paste');
      var companyFilter = document.getElementById('company-filter');
      var generateBtn = document.getElementById('generate-btn');
      var landingError = document.getElementById('landing-error');
      var landing = document.getElementById('landing');
      var mapView = document.getElementById('map-view');
      var mapTitle = document.getElementById('map-title');
      var totalCount = document.getElementById('total-count');
      var locationCount = document.getElementById('location-count');
      var panelClose = document.getElementById('panel-close');
      var panel = document.getElementById('panel');

      dropZone.addEventListener('dragover', function (e) {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.add('dragover');
      });
      dropZone.addEventListener('dragleave', function () {
        dropZone.classList.remove('dragover');
      });
      dropZone.addEventListener('drop', function (e) {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.remove('dragover');
        var file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
        if (file) readFile(file);
      });

      fileInput.addEventListener('change', function () {
        var file = fileInput.files && fileInput.files[0];
        if (file) readFile(file);
      });

      function readFile(file) {
        var reader = new FileReader();
        reader.onload = function () {
          csvPaste.value = reader.result;
          fileAttached.textContent = 'Attached: ' + file.name;
        };
        reader.readAsText(file, 'utf8');
      }

      generateBtn.addEventListener('click', function () {
        landingError.textContent = '';
        var csvText = (csvPaste.value || '').trim();
        if (!csvText) {
          landingError.textContent = 'Please paste CSV content or drop a file.';
          return;
        }
        var company = (companyFilter.value || '').trim();
        var result;
        try {
          result = window.TalentMapParser.processCSV(csvText, company || undefined);
        } catch (err) {
          landingError.textContent = 'Failed to parse CSV: ' + (err.message || err);
          return;
        }
        if (!result || result.totalEmployees === 0) {
          landingError.textContent = 'No employees found. Try a different company filter or check the CSV.';
          return;
        }
        landing.classList.add('hidden');
        mapView.classList.add('visible');
        mapTitle.textContent = result.companyName + ' – Talent Map';
        totalCount.textContent = result.totalEmployees;
        locationCount.textContent = result.locations.length;

        var container = document.getElementById('globe-container');
        container.innerHTML = '';
        function openPanel(loc) {
          var titleEl = document.getElementById('panel-title');
          var metaEl = document.getElementById('panel-meta');
          var contentEl = document.getElementById('panel-content');
          titleEl.textContent = loc.label || 'Unknown';
          metaEl.textContent = loc.count + ' employees at this location';
          contentEl.innerHTML = '';

          var depts = loc.departments || {};
          var deptNames = Object.keys(depts).sort(function (a, b) { return (depts[b].total || 0) - (depts[a].total || 0); });
          var tierLevelNames = result.tierLevelNames;
          var departmentColors = result.departmentColors;

          function escapeHtml(s) {
            if (s == null) return '';
            var div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
          }

          deptNames.forEach(function (deptName) {
            var deptData = depts[deptName];
            var color = departmentColors[deptName] || '#8b949e';
            var card = document.createElement('div');
            card.className = 'dept-card collapsed';
            card.style.setProperty('--dept-color', color);
            var header = document.createElement('div');
            header.className = 'dept-header';
            header.innerHTML = '<span class="dept-name">' + escapeHtml(deptName) + '</span><span class="dept-count">' + (deptData.total || 0) + ' employees</span>';
            var body = document.createElement('div');
            body.className = 'dept-body';
            var hierarchy = deptData.hierarchy || {};
            var tierOrder = ['0','1','2','3','4','5','6','7','8','9'];
            tierOrder.forEach(function (tierKey) {
              if (!hierarchy[tierKey]) return;
              var tier = hierarchy[tierKey];
              var section = document.createElement('div');
              section.className = 'tier-section';
              section.innerHTML = '<div class="tier-title">' + escapeHtml(tier.level || tierLevelNames[tierKey]) + ' (' + (tier.employees ? tier.employees.length : 0) + ')</div>';
              (tier.employees || []).forEach(function (emp) {
                var empCard = document.createElement('div');
                empCard.className = 'employee-card';
                var namePart = emp.linkedin
                  ? '<a href="' + escapeHtml(emp.linkedin) + '" target="_blank" rel="noopener">' + escapeHtml(emp.name) + '</a>'
                  : escapeHtml(emp.name);
                empCard.innerHTML = '<div class="emp-name">' + namePart + '</div><div class="emp-title">' + escapeHtml(emp.title || '') + '</div><div class="emp-location">' + escapeHtml(emp.location || '') + '</div>';
                section.appendChild(empCard);
              });
              body.appendChild(section);
            });
            header.addEventListener('click', function () { card.classList.toggle('collapsed'); });
            card.appendChild(header);
            card.appendChild(body);
            contentEl.appendChild(card);
          });
          panel.classList.add('open');
        }

        var globe = new Globe2D(container, {
          locations: result.locations,
          onPinClick: openPanel
        });
      });

      panelClose.addEventListener('click', function () {
        panel.classList.remove('open');
      });
    })();
  </script>
</body>
</html>
